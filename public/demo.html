
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>StudyConnect</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --brand:#4f46e5; --brand-2:#7c3aed; --ring:#6366f1; }
    html,body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol", sans-serif; }
    .glass { backdrop-filter: saturate(180%) blur(8px); background: rgba(255,255,255,.75); }
    .icon { width:18px; height:18px; }
    .btn-primary { display:inline-flex; align-items:center; gap:.5rem; padding:.5rem 1rem; border-radius:.5rem; font-weight:600; background:#4f46e5; color:#fff; box-shadow:0 1px 2px rgba(0,0,0,.06); transition:filter .15s, transform .02s; position:relative; }
    .btn-primary:hover { background:#4338ca; }
    .btn-primary:active { transform:translateY(1px); }
    .btn-primary.is-loading { pointer-events:none; opacity:.85; }
    .btn-primary.is-loading::after{
      content:""; position:absolute; right:.75rem; top:50%; margin-top:-8px;
      width:16px; height:16px; border:2px solid #fff; border-top-color:transparent;
      border-radius:50%; animation:spin .8s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg) } }
    .btn-outline { display:inline-flex; align-items:center; gap:.5rem; padding:.5rem 1rem; border-radius:.5rem; font-weight:600; background:#fff; color:#4338ca; border:1px solid #c7d2fe; }
    .btn-outline:hover { border-color:#a5b4fc; }
    .btn-soft { display:inline-flex; align-items:center; gap:.5rem; padding:.5rem 1rem; border-radius:.5rem; font-weight:600; background:#eef2ff; color:#4338ca; }
    .btn-soft:hover { background:#e0e7ff; }
    .btn-disabled { opacity:.55; cursor:not-allowed; filter:saturate(.6); }
    .chip { display:inline-flex; align-items:center; border-radius:9999px; padding:.25rem .625rem; font-size:.75rem; font-weight:500; background:#f3f4f6; color:#374151; }
    .badge { display:inline-flex; align-items:center; border-radius:9999px; padding:.125rem .5rem; font-size:11px; font-weight:700; }
    .line-clamp-3 { display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }

    /* Modal polish */
    #modalCreate input, #modalCreate textarea{
      width:100%; border:1px solid #e5e7eb; background:#fff; border-radius:.5rem;
      padding:.625rem .75rem; transition:box-shadow .15s, border-color .15s;
    }
    #modalCreate input:focus, #modalCreate textarea:focus{
      outline:0; border-color:var(--ring); box-shadow:0 0 0 3px rgba(99,102,241,.15);
    }
    #modalCreate .hint{font-size:.75rem;color:#6b7280}

    /* Toasts */
    .toast-wrap{position:fixed;right:1rem;bottom:1rem;display:grid;gap:.5rem;z-index:60}
    .toast{background:#111827;color:#fff;padding:.625rem .875rem;border-radius:.5rem;box-shadow:0 10px 20px rgba(0,0,0,.12)}
    .toast.ok{background:#065f46}
    .toast.err{background:#7f1d1d}
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
  <!-- Top sign-in bar -->
  <div id="signinBar" class="hidden">
    <div class="max-w-7xl mx-auto px-4 py-2">
      <div class="glass rounded-md px-4 py-2 flex items-center justify-between border border-indigo-100">
        <div class="text-sm">
          <span class="font-semibold">You’re not signed in.</span>
          <span>Sign in with Google to create and join meetings.</span>
        </div>
        <a href="/auth/google" class="btn-primary">Sign in with Google</a>
      </div>
    </div>
  </div>

  <!-- NAV -->
  <header class="bg-white/80 backdrop-blur border-b border-gray-100 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center gap-4">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl grid place-items-center text-white font-bold"
             style="background:linear-gradient(135deg,var(--brand),var(--brand-2))">SC</div>
        <div class="text-lg font-semibold">StudyConnect</div>
      </div>

      <div class="flex-1"></div>

      <div class="hidden lg:block w-[520px]">
        <label class="relative block">
          <input id="searchInput" type="search" placeholder="Search meetings, topics, or subjects..."
                 class="w-full rounded-md border border-gray-200 pl-10 pr-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          <svg class="icon absolute left-3 top-2.5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.9 14.32a8 8 0 111.414-1.414l4.387 4.387-1.414 1.414-4.387-4.387zM8 14a6 6 0 100-12 6 6 0 000 12z" clip-rule="evenodd"/>
          </svg>
        </label>
      </div>

      <button id="btnCreateTop" class="btn-primary ml-2">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Create Meeting
      </button>
    </div>
  </header>

  <!-- HERO -->
  <section class="relative">
    <div class="absolute inset-0 -z-10"
         style="background: radial-gradient(1200px 500px at 20% -10%, #c7d2fe55, transparent),
                          radial-gradient(1200px 500px at 80% -10%, #ddd6fe66, transparent),
                          linear-gradient(180deg, #ffffff, #f8fafc);"></div>

    <div class="max-w-7xl mx-auto px-4">
      <div class="py-14 lg:py-20 text-center">
        <h1 class="text-4xl lg:text-6xl font-extrabold tracking-tight">
          <span class="block">Connect. Study. Succeed.</span>
        </h1>
        <p class="mt-4 text-lg text-gray-600 max-w-3xl mx-auto">
          Join collaborative study sessions, discover study groups, and excel in your academic journey with fellow students.
        </p>

        <div class="mt-8 flex items-center justify-center gap-3">
          <a href="#meetings" class="btn-primary">
            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M8 7h8M7 11h10M6 15h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            Browse Meetings
          </a>
          <button class="btn-outline" id="btnCreateHero">
            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            Create Study Group
          </button>
        </div>

        <!-- Stats grid -->
        <div class="mt-12 grid grid-cols-2 md:grid-cols-4 gap-4">
          <!-- Active Students -->
          <div class="rounded-xl bg-white border border-gray-100 shadow-sm p-5 flex items-center gap-4">
            <div class="h-10 w-10 rounded-lg bg-indigo-50 text-indigo-600 grid place-items-center">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M16 11a4 4 0 10-8 0 4 4 0 008 0zM3 20a7 7 0 0114 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </div>
            <div>
              <div id="statActive" class="text-2xl font-extrabold">0</div>
              <div class="text-gray-500 text-sm">Active Students</div>
            </div>
          </div>
          <!-- Study Sessions -->
          <div class="rounded-xl bg-white border border-gray-100 shadow-sm p-5 flex items-center gap-4">
            <div class="h-10 w-10 rounded-lg bg-indigo-50 text-indigo-600 grid place-items-center">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M8 7h8M7 11h10M6 15h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </div>
            <div>
              <div id="statUpcoming" class="text-2xl font-extrabold">0</div>
              <div class="text-gray-500 text-sm">Study Sessions</div>
            </div>
          </div>
          <!-- Subjects Covered -->
          <div class="rounded-xl bg-white border border-gray-100 shadow-sm p-5 flex items-center gap-4">
            <div class="h-10 w-10 rounded-lg bg-indigo-50 text-indigo-600 grid place-items-center">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </div>
            <div>
              <div id="statSubjects" class="text-2xl font-extrabold">0</div>
              <div class="text-gray-500 text-sm">Subjects Covered</div>
            </div>
          </div>
          <!-- Total Students -->
          <div class="rounded-xl bg-white border border-gray-100 shadow-sm p-5 flex items-center gap-4">
            <div class="h-10 w-10 rounded-lg bg-indigo-50 text-indigo-600 grid place-items-center">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M3 7l9-4 9 4-9 4-9-4zM3 12l9 4 9-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </div>
            <div>
              <div id="statUsers" class="text-2xl font-extrabold">0</div>
              <div class="text-gray-500 text-sm">Total Students</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- FILTERS -->
  <section id="meetings" class="max-w-7xl mx-auto px-4">
    <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-4 md:p-6">
      <div class="flex items-center gap-2 text-gray-800 font-semibold">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M7 12h10M10 18h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Filter Meetings
      </div>

      <div class="mt-4 grid gap-3 md:grid-cols-3">
        <label class="block text-sm">
          <span class="text-gray-600">Academic Level</span>
          <select id="fLevel" class="mt-1 w-full border-gray-200 rounded-md">
            <option value="">All Levels</option>
          </select>
        </label>
        <label class="block text-sm">
          <span class="text-gray-600">Subject</span>
          <select id="fSubject" class="mt-1 w-full border-gray-200 rounded-md">
            <option value="">All Subjects</option>
          </select>
        </label>
        <label class="block text-sm">
          <span class="text-gray-600">Meeting Type</span>
          <select id="fType" class="mt-1 w-full border-gray-200 rounded-md">
            <option value="">All Types</option>
            <option value="online">Online</option>
            <option value="inperson">In-Person</option>
          </select>
        </label>
      </div>
    </div>
  </section>

  <!-- CARDS -->
  <section class="max-w-7xl mx-auto px-4 mt-6 mb-16" id="cardsWrap">
    <h2 class="sr-only">Upcoming Study Sessions</h2>
    <div id="cards" class="grid gap-5 md:grid-cols-2 xl:grid-cols-3"></div>
    <div id="empty" class="hidden text-center text-gray-500 py-12">No meetings match your filters.</div>
  </section>

  <!-- CREATE MODAL -->
  <dialog id="modalCreate" class="backdrop:bg-black/40 rounded-lg w-[560px] max-w-[95vw] p-0">
    <form id="createForm" class="p-6">
      <div class="text-lg font-semibold">Create Meeting</div>
      <div class="mt-4 grid md:grid-cols-2 gap-4">
        <label class="text-sm">Title
          <input id="fTitle" name="title" required class="w-full mt-1 rounded-md border-gray-200" maxlength="120"/>
          <span class="hint">Keep it short and clear</span>
        </label>
        <label class="text-sm">Subject
          <input name="subject" class="w-full mt-1 rounded-md border-gray-200"/>
        </label>
        <label class="text-sm">Level
          <input name="level" class="w-full mt-1 rounded-md border-gray-200" placeholder="e.g. L1, 2eme Annee"/>
        </label>
        <label class="text-sm">Specialization
          <input name="specialization" class="w-full mt-1 rounded-md border-gray-200" placeholder="e.g. ISI, ALG"/>
        </label>
        <label class="text-sm">Start
          <input name="startTime" type="datetime-local" required class="w-full mt-1 rounded-md border-gray-200"/>
          <span class="hint">Meeting will last 1 hour by default</span>
        </label>
        <label class="text-sm md:col-span-2">Location
          <input id="fLocation" name="location" class="w-full mt-1 rounded-md border-gray-200" placeholder="Room or place"/>
          <span class="hint">Example B-205 Library</span>
        </label>
        <label class="text-sm md:col-span-2">Online URL
          <input id="fOnlineUrl" name="onlineUrl" class="w-full mt-1 rounded-md border-gray-200" placeholder="Zoom/Meet link (optional)"/>
          <span class="hint">Example https://meet.google.com/abc-defg-hij</span>
        </label>
        <label class="text-sm md:col-span-2">Description
          <textarea name="description" rows="3" class="w-full mt-1 rounded-md border-gray-200"></textarea>
        </label>
      </div>
      <div class="mt-6 flex justify-end gap-2">
        <button type="button" class="btn-outline" onclick="modalCreate.close()">Cancel</button>
        <button id="btnSubmitCreate" class="btn-primary relative">Create</button>
      </div>
    </form>
  </dialog>

  <!-- Toasts -->
  <div id="toasts" class="toast-wrap"></div>

  <script>
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => [...el.querySelectorAll(s)];
    const cardsEl = qs('#cards');
    const emptyEl = qs('#empty');
    const searchInput = qs('#searchInput');
    const fLevel = qs('#fLevel');
    const fSubject = qs('#fSubject');
    const fType = qs('#fType');
    const modalCreate = qs('#modalCreate');
    const createForm = qs('#createForm');
    const submitBtn = qs('#btnSubmitCreate');

    let currentUser = null;
    let raw = [];

    // secure auth check
    async function checkAuth() {
      const res = await fetch('/auth/me', { credentials: 'include' });

      if (res.status === 200) {
        currentUser = await res.json().catch(() => null);
        qs('#signinBar').classList.add('hidden');
        return true;
      }

      currentUser = null;
      window.location.href = '/auth.html';
      return false;
    }

    // open modal + autofocus title
    qs('#btnCreateTop').onclick  = () => { modalCreate.showModal(); setTimeout(()=>qs('#fTitle')?.focus(), 40); };
    qs('#btnCreateHero').onclick = () => { modalCreate.showModal(); setTimeout(()=>qs('#fTitle')?.focus(), 40); };

    // Esc to close modal
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modalCreate.open) modalCreate.close(); });

    function fmtDate(dt) {
      const d = new Date(dt);
      const optsD = { month: 'short', day: 'numeric', year: 'numeric' };
      const optsT = { hour: '2-digit', minute: '2-digit' };
      return { date: d.toLocaleDateString([], optsD), time: d.toLocaleTimeString([], optsT) };
    }

    const isOnline = m => !!(m.onlineUrl && m.onlineUrl.trim() !== '');
    const whereText = m => isOnline(m) ? 'Online Meeting' : (m.location || '-');

    function renderBadgeType(m) {
      const online = isOnline(m);
      const c = online ? 'bg-blue-50 text-blue-700' : 'bg-purple-50 text-purple-700';
      const label = online ? 'Online' : 'In-Person';
      return `<span class="badge ${c}">${label}</span>`;
    }

    function userJoined(m) {
      if (!currentUser) return false;
      return (m.attendees || []).some(a => a.userId === currentUser.id);
    }
    function isOwner(m) {
      if (!currentUser) return false;
      return m.createdById === currentUser.id;
    }
    function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

    function card(m) {
      const s = fmtDate(m.startTime), e = fmtDate(m.endTime);
      const tags = [
        m.level ? `<span class="chip">${escapeHtml(m.level)}</span>` : '',
        m.subject ? `<span class="chip">${escapeHtml(m.subject)}</span>` : '',
        m.specialization ? `<span class="chip">${escapeHtml(m.specialization)}</span>` : ''
      ].filter(Boolean).join(' ');

      const joined = userJoined(m);
      const owner  = isOwner(m);

      const actionsHtml = owner
        ? `
          <button class="btn-soft btn-disabled" disabled>Your Meeting</button>
          <button
            class="btn-outline text-red-600 border-red-200 hover:border-red-400"
            data-delete-id="${m.id}"
          >
            Delete
          </button>
        `
        : `<button class="btn-soft ${joined ? 'btn-disabled' : ''}" ${joined ? 'disabled' : `data-join-id="${m.id}"`}>
             ${joined ? 'Joined ✓' : 'Join Meeting'}
           </button>`;

      return `
      <div class="rounded-2xl bg-white border border-gray-100 shadow-sm p-5 flex flex-col">
        <div class="flex items-start justify-between gap-3">
          <h3 class="text-lg font-semibold">${escapeHtml(m.title)}</h3>
          ${renderBadgeType(m)}
        </div>
        <p class="mt-2 text-sm text-gray-600 line-clamp-3">${escapeHtml(m.description || '')}</p>

        <div class="mt-4 space-y-2 text-sm">
          <div class="flex items-center gap-2 text-gray-700">
            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M8 7h8M7 11h10M6 15h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <span>${s.date}</span><span class="mx-1 text-gray-400">•</span><span>${s.time} – ${e.time}</span>
          </div>
          <div class="flex items-center gap-2 text-gray-700">
            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 2a7 7 0 00-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 00-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>${escapeHtml(whereText(m))}</span>
          </div>
        </div>

        <div class="mt-3 flex flex-wrap gap-2">${tags}</div>

        <div class="mt-5 flex items-center justify-between">
          <div class="text-xs text-gray-500">${(m.attendees?.length ?? 0)} attending</div>
          <div class="flex items-center gap-2">
            ${actionsHtml}
          </div>
        </div>
      </div>`;
    }

    function fillFilters(items) {
      const levels = [...new Set(items.map(x => x.level).filter(Boolean))].sort();
      const subjects = [...new Set(items.map(x => x.subject).filter(Boolean))].sort();
      fLevel.innerHTML   = `<option value="">All Levels</option>`   + levels.map(v=>`<option>${escapeHtml(v)}</option>`).join('');
      fSubject.innerHTML = `<option value="">All Subjects</option>` + subjects.map(v=>`<option>${escapeHtml(v)}</option>`).join('');
    }

    function applyFilters() {
      const q = (searchInput.value || '').toLowerCase().trim();
      const lv = fLevel.value, sb = fSubject.value, tp = fType.value;

      let list = raw.slice();
      if (q) {
        list = list.filter(x =>
          (x.title||'').toLowerCase().includes(q) ||
          (x.description||'').toLowerCase().includes(q) ||
          (x.subject||'').toLowerCase().includes(q)
        );
      }
      if (lv) list = list.filter(x => x.level === lv);
      if (sb) list = list.filter(x => x.subject === sb);
      if (tp) list = list.filter(x => (isOnline(x) ? 'online' : 'inperson') === tp);

      cardsEl.innerHTML = list.map(card).join('');
      emptyEl.classList.toggle('hidden', list.length !== 0);
    }

    async function fetchMeetings() {
      const res = await fetch('/api/meetings', { credentials: 'include' });
      raw = await res.json();
      fillFilters(raw);
      applyFilters();
    }

    // Google Calendar template helpers
    function toGCalDate(dt) {
      const d = new Date(dt);
      const pad = n => String(n).padStart(2,'0');
      return (
        d.getUTCFullYear() +
        pad(d.getUTCMonth()+1) +
        pad(d.getUTCDate()) + 'T' +
        pad(d.getUTCHours()) +
        pad(d.getUTCMinutes()) +
        pad(d.getUTCSeconds()) + 'Z'
      );
    }
    function openGCalTemplate(m) {
      const base = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
      const text    = encodeURIComponent(m.title || 'StudyConnect Meeting');
      const details = encodeURIComponent((m.description || '') + '\n- Created via StudyConnect');
      const location= encodeURIComponent(m.onlineUrl || m.location || '');
      const dates   = `${toGCalDate(m.startTime)}/${toGCalDate(m.endTime)}`;
      const url = `${base}&text=${text}&details=${details}&location=${location}&dates=${dates}`;
      window.open(url, '_blank', 'noopener,noreferrer');
    }

    // Join + open template
    async function joinMeeting(id) {
      const btn = document.querySelector(`[data-join-id="${CSS.escape(id)}"]`);
      btn?.classList.add('btn-disabled');
      btn?.setAttribute('disabled','');

      try {
        const res = await fetch(`/api/meetings/${id}/join`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });

        if (res.status === 401) { window.location.href = '/auth/google'; return; }

        let data = {}; try { data = await res.json(); } catch {}
        if (!res.ok && data?.note !== 'Already joined') { toast(`Join failed: ${data.error || res.status}`,'err'); return; }

        const m = raw.find(x => x.id === id);
        if (m) openGCalTemplate(m);

        await fetchMeetings();
        await fetchStats();
      } finally {
        btn?.classList.remove('btn-disabled');
        btn?.removeAttribute('disabled');
      }
    }

    async function deleteMeeting(id) {
      if (!confirm('Delete this meeting for everyone?')) return;

      try {
        const res = await fetch(`/api/meetings/${id}`, {
          method: 'DELETE',
          credentials: 'include',
        });

        if (res.status === 401) {
          location.href = '/auth/google';
          return;
        }

        if (!res.ok) {
          const text = await res.text().catch(() => '');
          toast('Delete failed','err');
          alert('Delete failed. ' + text);
          return;
        }

        toast('Meeting deleted','ok');
        await fetchMeetings();
        await fetchStats();
      } catch (e) {
        toast('Delete failed','err');
      }
    }

    // global click handler for join + delete
    document.addEventListener('click', (e) => {
      const joinBtn = e.target.closest('[data-join-id]');
      if (joinBtn) {
        const id = joinBtn.getAttribute('data-join-id');
        if (id) joinMeeting(id);
        return;
      }

      const delBtn = e.target.closest('[data-delete-id]');
      if (delBtn) {
        const id = delBtn.getAttribute('data-delete-id');
        if (id) deleteMeeting(id);
        return;
      }
    });

    // tiny utils
    function toast(msg,type='ok',ms=2600){
      const wrap = qs('#toasts'); const el = document.createElement('div');
      el.className = `toast ${type}`; el.textContent = msg; wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity='.0'; setTimeout(()=>el.remove(),300); }, ms);
    }
    function isUrl(s){ if(!s) return false; try{ new URL(s); return true } catch { return false } }

    // Stats
    async function fetchStats() {
      try {
        const r = await fetch('/api/stats', { credentials: 'include' });
        const s = await r.json();
        const n = x => (x >= 1000 ? x.toLocaleString() : String(x));
        document.getElementById('statActive').textContent   = n(s.activeUsers24h);
        document.getElementById('statUpcoming').textContent = n(s.upcomingMeetings);
        document.getElementById('statSubjects').textContent = n(s.subjectsCount);
        document.getElementById('statUsers').textContent    = n(s.totalUsers);
      } catch {}
    }

    // Create meeting with spinner + validation
    createForm.onsubmit = async (e) => {
      e.preventDefault();

      const fd = new FormData(createForm);
      const payload = Object.fromEntries(fd.entries());

      if (payload.onlineUrl && !isUrl(payload.onlineUrl.trim())) {
        toast('Please enter a valid online link','err'); return;
      }

      if (payload.startTime) {
        const start = new Date(payload.startTime);
        const end = new Date(start.getTime() + 60 * 60 * 1000);
        payload.startTime = start.toISOString();
        payload.endTime = end.toISOString();
      }

      submitBtn.classList.add('is-loading');

      try {
        const res = await fetch('/api/meetings', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.status === 201) {
          modalCreate.close();
          createForm.reset();
          toast('Meeting created','ok');
          await fetchMeetings();
          await fetchStats();
        } else if (res.status === 400) {
          const j = await res.json().catch(()=>null);
          toast('Validation failed','err');
          alert('Validation failed:\n' + JSON.stringify(j, null, 2));
        } else if (res.status === 401) {
          toast('Sign in required','err');
          location.href = '/auth/google';
        } else {
          const text = await res.text().catch(()=> '');
          toast('Create failed','err');
          alert('Create failed. ' + text);
        }
      } finally {
        submitBtn.classList.remove('is-loading');
      }
    };

    // Filters & search
    [searchInput,fLevel,fSubject,fType].forEach(el=>el?.addEventListener('input', applyFilters));

    // init
    (async function init(){
      await checkAuth();
      await Promise.all([fetchMeetings(), fetchStats()]);
      setInterval(fetchStats, 60_000);
    })();
  </script>

</body>
</html>
